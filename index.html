<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Workbox PWA Demo</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      h1 { color: #333; }
      .status {
        padding: 10px 15px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .status.pending { background: #fff3cd; color: #856404; }
      .status.success { background: #d4edda; color: #155724; }
      .status.error { background: #f8d7da; color: #721c24; }
      button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      .btn-primary { background: #007bff; color: white; }
      .btn-danger { background: #dc3545; color: white; }
      .btn-primary:hover { background: #0056b3; }
      .btn-danger:hover { background: #c82333; }
      pre {
        background: #f4f4f4;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
      }
      #cache-list { margin-top: 20px; }
      .logo {
        width: 30px;
        height: 30px;
      }
    </style>
  </head>
  <body>
    <h1>Workbox PWA Demo</h1>
    <img class="logo" src="https://assets.voya.world/admin/20251231/6954e8a17ac9d76954e8a17aca0.png" alt="logo" />
    <div id="sw-status" class="status pending">
      Service Worker: Checking...
    </div>

    <div>
      <button class="btn-primary" onclick="refreshCacheList()">View Caches</button>
      <button class="btn-danger" onclick="clearAll()">Clear All Caches</button>
    </div>

    <div id="cache-list"></div>

    <script type="module">
      import { registerSW, clearAllSWAndCaches } from './registerSW.ts';

      const statusEl = document.getElementById('sw-status');
      const cacheListEl = document.getElementById('cache-list');

      // 开发模式检测
      const isDev = import.meta.env.DEV;

      if (isDev) {
        // 开发模式: injectManifest 不支持开发时自动编译 SW
        // 请使用 npm run build && npm run preview 测试完整 SW 功能
        statusEl.className = 'status pending';
        statusEl.textContent = 'Service Worker: Disabled in dev (use: npm run build && npm run preview)';
      } else {
        // 生产模式注册 SW
        registerSW({
          swPath: import.meta.env.BASE_URL + 'sw.js',
          scope: import.meta.env.BASE_URL,
          onSuccess: (reg) => {
            statusEl.className = 'status success';
            statusEl.textContent = 'Service Worker: Registered';
          },
          onActivated: (reg) => {
            statusEl.className = 'status success';
            statusEl.textContent = 'Service Worker: Activated';
            refreshCacheList();
          },
          onError: (err) => {
            statusEl.className = 'status error';
            statusEl.textContent = `Service Worker: Error - ${err.message}`;
          },
        });
      }

      // 查看缓存列表
      window.refreshCacheList = async function() {
        const cacheNames = await caches.keys();

        if (cacheNames.length === 0) {
          cacheListEl.innerHTML = '<p>No caches found.</p>';
          return;
        }

        let html = '<h3>Cache Storage:</h3>';
        for (const name of cacheNames) {
          const cache = await caches.open(name);
          const keys = await cache.keys();
          html += `<details>
            <summary><strong>${name}</strong> (${keys.length} items)</summary>
            <pre>${keys.map(k => k.url).join('\n')}</pre>
          </details>`;
        }
        cacheListEl.innerHTML = html;
      };

      // 清除所有缓存
      window.clearAll = async function() {
        await clearAllSWAndCaches();
        statusEl.className = 'status pending';
        statusEl.textContent = 'Service Worker: Cleared, refresh to re-register';
        cacheListEl.innerHTML = '<p>All caches cleared.</p>';
      };
    </script>
  </body>
</html>
